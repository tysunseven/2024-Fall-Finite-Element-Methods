# 2024-Fall-Finite-Element-Methods

<p><a href="Finite Element Methods.pdf">笔记和书面作业</a></p>

- [2024-Fall-Finite-Element-Methods](#2024-fall-finite-element-methods)
  - [回顾有限差分方法](#回顾有限差分方法)
  - [两点边值问题、变分问题、极小化问题](#两点边值问题变分问题极小化问题)
  - [有限元方法的基本思想](#有限元方法的基本思想)
  - [基循环→单元循环](#基循环单元循环)
  - [误差估计](#误差估计)


## 回顾有限差分方法
考虑两点边值问题

$$ 
(\mathrm{P}):\begin{cases}
 -u''(x) = f(x), & 0 < x < 1, \\
u(0) = u(1) = 0, &
\end{cases} 
$$

为了使用有限差分方法求解这个问题, 我们首先将区间 $[0,1]$ 离散化. 假设将区间划分为 $n+1$ 个等距节点，步长为 $h = \frac{1}{n+1}$, 节点的坐标为 $x_i = ih$, 其中 $i = 0, 1, 2, \dots, n+1$. 记 $ u_i=u(x_i) $, 根据边界条件，$u_0 = u_{n+1} = 0$，所以我们只需要求解内部节点 $u_1, u_2, \dots, u_n$. 为此我们需要将 $ u''(x) $离散化. 对 $u(x+h)$ 和 $u(x-h)$ 进行泰勒展开：

$$
u(x+h) = u(x) + h u'(x) + \frac{h^2}{2} u''(x) + \frac{h^3}{6} u^{(3)}(x) + \frac{h^4}{24} u^{(4)}(x) + \dots
$$

$$
u(x-h) = u(x) - h u'(x) + \frac{h^2}{2} u''(x) - \frac{h^3}{6} u^{(3)}(x) + \frac{h^4}{24} u^{(4)}(x) - \dots
$$

将 $u(x+h)$ 和 $u(x-h)$ 相加：

$$
u(x+h) + u(x-h) = 2u(x) + h^2 u''(x) + \frac{h^4}{12} u^{(4)}(x) + \dots
$$

将上面的式子进行整理：

$$
u(x+h) + u(x-h) = 2u(x) + h^2 u''(x) + O(h^4)
$$

进一步，得到二阶导数的表达式：

$$
u''(x) \approx \frac{u(x+h) - 2u(x) + u(x-h)}{h^2}
$$


在离散化过程中，二阶导数 $u''(x)$ 可以通过中心差分公式近似为：

$$
u''(x_i) \approx \frac{u_{i+1} - 2u_i + u_{i-1}}{h^2}.
$$

因此，微分方程 $-u''(x) = f(x)$ 在离散化后对于每个内部节点 $x_i$ 可以表示为：

$$
-\frac{u_{i+1} - 2u_i + u_{i-1}}{h^2} = f(x_i), \quad i = 1, 2, \dots, n.
$$

整理后可以得到以下的线性代数方程：

$$
u_{i-1} - 2u_i + u_{i+1} = -h^2 f(x_i), \quad i = 1, 2, \dots, n.
$$

这组方程可以写成一个线性系统的矩阵形式：

$$
A \mathbf{u} = \mathbf{b},
$$

其中，$\mathbf{u} = [u_1, u_2, \dots, u_n]^T$ 是待求的未知向量，$\mathbf{b} = [-h^2 f(x_1), -h^2 f(x_2), \dots, -h^2 f(x_n)]^T$ 是已知的右端项向量。矩阵 $A$ 是一个 $n \times n$ 的三对角矩阵，形式为：

$$
A = \begin{pmatrix}
  -2 & 1  & 0  & \cdots & 0 \\
  1  & -2 & 1  & \cdots & 0 \\
  0  & 1  & -2 & \cdots & 0 \\
  \vdots & \vdots & \vdots & \ddots & 1 \\
  0  & 0  & 0  & 1  & -2
\end{pmatrix}.
$$

通过求解该线性系统，我们可以得到节点处的近似解 $\mathbf{u}$，进而构造出整个区间上的解的近似值. 有限差分方法虽然简单且易于实现，但也存在一些明显的缺点：

1. **几何区域的局限性**：有限差分方法通常适用于规则的几何区域，例如矩形或正方形等。对于复杂的几何区域，网格划分和离散化变得非常困难，且需要进行特殊处理，这可能会导致精度下降或者方法变得非常复杂。

2. **边界条件的处理困难**：有限差分方法对于简单的边界条件（如Dirichlet边界条件或Neumann边界条件）较为容易处理。然而，当遇到更复杂的边界条件（如Robin边界条件或不规则边界），有限差分方法的实现将变得更加复杂，可能需要特殊的技巧或近似处理，甚至影响求解的精度和稳定性。

3. **高维问题的计算复杂度**：在高维问题（例如三维的偏微分方程）中，有限差分方法需要对空间进行离散化，导致离散化点数目急剧增加。对于大规模问题，生成的线性方程组的规模很大，导致计算代价和存储需求显著增加，且矩阵的稀疏性可能不如其他数值方法（如有限元方法）处理得好。

4. **适应性较差**：有限差分方法在网格生成上较为僵硬，通常依赖于均匀的网格划分，因此对于局部特征变化较大的问题（如边界层或奇异点附近），需要全局细化网格，导致大量不必要的计算。而像有限元方法那样可以采用自适应网格来集中计算精度的局部区域，有限差分方法则较难实现。

这些缺点使得有限差分方法在处理复杂几何或边界条件时不如有限元方法和有限体积方法那样灵活。因此，有限差分方法通常适用于简单几何形状上的基本边值问题，而在处理实际工程问题或复杂边界条件时，往往需要考虑其他数值方法。

## 两点边值问题、变分问题、极小化问题

首先，原始的两点边值问题是：

$$
\begin{cases}
 -u''(x) = f(x), & 0 < x < 1, \\
u(0) = u(1) = 0.
\end{cases}
$$

我们通过引入弱解的思想，将其转化为变分问题。以下是等价的变分形式的步骤：

1. **测试函数空间的定义**：
   定义合适的函数空间 $ V $，通常选择满足边界条件的函数集：

   $$
   V = \{ v \in C^1([0,1]) \mid v(0) = v(1) = 0 \}.
   $$

   这是包含所有在区间 $ [0,1] $ 上连续且可微，并且在边界处 $ x = 0 $ 和 $ x = 1 $ 为零的函数的空间。

2. **弱解的定义**：
   对于每一个测试函数 $ v \in V $，将方程的二阶导数部分进行积分，通过分部积分，将二阶导数的微分方程变为一阶导数的形式。目标是消除对二阶导数的依赖。

   从原始方程 $ -u''(x) = f(x) $ 出发，对整个区间 $ [0, 1] $ 做积分：

   $$
   \int_0^1 -u''(x)v(x)\,dx = \int_0^1 f(x)v(x)\,dx.
   $$

   通过分部积分并结合边界条件 $ u(0) = u(1) = 0 $，可以将左边的项转化为：

   $$
   \int_0^1 u'(x)v'(x)\,dx = \int_0^1 f(x)v(x)\,dx.
   $$

3. **变分问题的等价形式**：
   因此，两点边值问题的弱解（即变分问题的形式）为：

   **寻找** $ u \in V $，使得对于任意的 $ v \in V $，满足以下条件：

   $$
   \int_0^1 u'(x)v'(x)\,dx = \int_0^1 f(x)v(x)\,dx.
   $$

这就是两点边值问题的等价变分形式。通过这个过程，我们将原来的二阶微分方程转化为一阶导数的积分形式，适用于弱解的概念。

结合课程板书，继续介绍极小化问题。

从变分问题的弱形式出发，我们可以进一步将其理解为一个极小化问题。具体来说，变分问题的弱解可以通过极小化某个能量泛函来得到。

假设我们定义如下的能量泛函：

$$
J(u) = \frac{1}{2} \int_0^1 |u'(x)|^2 dx - \int_0^1 f(x)u(x) dx,
$$

那么，可以证明，解变分问题的函数 $ u $ 也是极小化该能量泛函的函数。换句话说，寻找方程的解 $ u $ 相当于寻找一个使得能量泛函 $ J(u) $ 取最小值的函数。

因此，变分问题可以转化为以下的极小化问题：

**寻找** $ u \in V $ 使得：

$$
J(u) = \min_{v \in V} J(v),
$$

其中 $ V $ 是满足边界条件的函数空间。

这个极小化问题的物理意义可以理解为寻找系统的最低能量状态。在这个背景下，弱解就是使能量泛函最小的函数。这种方法在许多物理和工程问题中非常常见，尤其是在弹性力学、电磁学等领域。

通过求解极小化问题，我们可以得到与两点边值问题等价的数值解。具体的数值方法，如有限元法，通常就是基于这个极小化框架来进行离散化和求解的。也成为Ritz意义下的弱解


> **变分问题的解是极小化问题的解**

假设 $ u $ 是变分问题 $ (W) $ 的解. 对于任意 $ v \in V $，要证 $ J(u) \leqslant J(v) $.

令 $ w = v - u $，则 $ v = u + w $. 直接计算有

$$
J(v) = J(u + w) = \frac{1}{2}a(u + w, u + w) - (f, u + w)
$$

$$
= \frac{1}{2}(u', u') + \frac{1}{2}(w', w') + (u', w') - (f, u) - (f, w)
$$

因为 $ u $ 是 $ (W) $ 的解, 且 $ w \in V $, 由定义知

$$
(u', w') - (f, w) = 0
$$

故

$$
J(v) = J(u) + \frac{1}{2}(w', w') \geqslant J(u).
$$

> **极小化问题的解是变分问题的解**

对于任意 $ v \in V $, 有 $ u + \varepsilon v \in V $, 

$$
J(u) \leqslant J(u + \varepsilon v)
$$

令 $  $

$$
g(\varepsilon) = J(u + \varepsilon v)= \frac{1}{2}a(u + \varepsilon v, u + \varepsilon v) - (f, u + \varepsilon v)
$$

$$
= \frac{1}{2}(u', u') + \varepsilon(u', v') + \frac{\varepsilon^2}{2}(v', v') - (f, u) - \varepsilon(f, v)
$$

由于 $ g(\varepsilon) $ 在 $ \varepsilon = 0 $ 时取极小值，故有

$$
g'(0) = (u', v') - (f, v) = 0.
$$

> **变分问题的 $ C^2 $ 解是两点边值问题的解**

设 $ u\in C^2[0,1]  $ 是变分问题 $ (W) $ 的解，对任意 $ v\in V $,

$$
0 = \int_0^1 u' v' \mathrm{d}x - \int_0^1 f v \mathrm{d}x = -\int_0^1 u'' v \mathrm{d}x + \left[ u'(1)v(1) - u'(0)v(0) \right] - \int_0^1 f v \mathrm{d}x
$$

由于边界条件 $ v(0) = v(1) = 0 $，上述表达式化简为：

$$
-\int_0^1 u'' v \mathrm{d}x = \int_0^1 f v \mathrm{d}x,\quad \forall v\in V\Longrightarrow -u''=f.
$$

> **变分问题解的唯一性**

假设 $ u_1, u_2 $ 是 $ (W) $ 问题的解, 则

$$
a(u_1 - u_2, v) = 0, \quad \forall v \in V
$$

取 $ v = u_1 - u_2 $, 则

$$
a(u_1 - u_2, u_1 - u_2)= \int_0^1 (u_1' - u_2')^2 \mathrm{d}x = 0\Longrightarrow u_1'-u_2'\equiv 0
$$

故 $ u_1 - u_2 $ 为常数. 又因边界条件 $ u_1(0) = u_2(0) $，故 $ u_1 = u_2 $.

## 有限元方法的基本思想
首先将两点边值问题转化为弱化的变分问题或极小化问题, 然后用有限维求解空间 $ V_h \subset V $ 代替无限维求解空间 $ V $, 得到变分问题或极小化问题的有限维近似版本的解 $ u_h $, 期待 $ u_h $ 收敛于 $ u $.

下面我们以Baby问题为例，展示求解过程. 首先把区间 $[0,1]$ 分成
$$
0=x_0<x_1<\cdots<x_N<x_{N+1}=1
$$

一共 $ N $ 个中间分点, $ N+1 $ 个区间, 记 $ I_j=(x_{j-1},x_j) $, $ h_j=x_{j}-x_{j-1} $, $h = \max h_i$. 定义连续分段一次多项式函数空间（实际上这个空间依赖于区间的剖分, 但我们在记号上只体现出最大区间长度$ h $）
$$
V_h=\lbrace v\in C[0,1]\mid v(0)=v(1)=0, v\mid_{I_j}\in \mathbb{P}_1(I_j), j=1,\cdots,N+1 \rbrace
$$

考虑变分问题, 我们也就是要寻找 $ u_h\in V_h $ 使得
$$
a(u_h,v_h)=(f,v_h),\quad \forall v_h\in V_h
$$

如果我们能找到 $ V_h $ 的一组基 $ \lbrace \phi_{i} \rbrace_{i=1}^N $, 那么上述要求等价于（我还没说明 $V_h$ 的维数就是 $N$, 但这里就这样用了）
$$
a(u_h,\phi_i)=(f,\phi_i),\quad i=1,\cdots,N.
$$

如果我们将 $ u_h $ 按基展开 $ u_h=u_i\phi_i $, 那么上述要求等价于
$$  
u_ia(\phi_i,\phi_j)=(f,\phi_j),\quad j=1,\cdots,N\Longleftrightarrow AU=F.
$$

我们使用如下的基函数

$$ \phi_j(x)=\frac{x - x_{j-1}}{x_j - x_{j-1}},x \in [x_{j-1}, x_j]\quad \frac{x_{j+1} - x}{x_{j+1} - x_j},x \in [x_j, x_{j+1}],\quad j=1,\cdots ,N. $$

容易想明白 $ \lbrace \phi_i \rbrace_{i=1}^N $ 确实构成 $ V_h $ 的一组基, 并且对于 $ v\in V_h $, 有

$$ v(x)=v(x_j)\phi_j(x). $$

接下来我们计算矩阵 $ A $ 的系数

$$
A_{ij} = a(\phi_i, \phi_j) = \int_0^1 \phi_i'\phi_j' \mathrm{d}x
$$

$$
A =
\begin{pmatrix}
\frac{1}{h_1} + \frac{1}{h_2} & -\frac{1}{h_2} & 0 & \dots & 0 \\
-\frac{1}{h_2} & \frac{1}{h_2} + \frac{1}{h_3} & -\frac{1}{h_3} & \dots & 0 \\
0 & -\frac{1}{h_3} & \ddots & \ddots & \vdots \\
\vdots & & \ddots & & -\frac{1}{h_N} \\
0 & \dots & & -\frac{1}{h_N} & \frac{1}{h_N}+\frac{1}{h_{N+1}}
\end{pmatrix}
$$



## 基循环→单元循环
此处的循环指的是我们在代码中组装刚度矩阵 $ A $ 的方式, 在前面的分析中, 我们是从方程组 $ (u_h,\phi_j)=(f,\phi_j) $ 出发, 通过遍历基函数 $ \phi_j $ 来依次得到 $ A $ 的第 $ j $ 行. 这种想法非常自然, 但在推广到高维的时候会比较困难, 因为比如三角网格上的基函数会比较复杂, 为此我们接下来考虑另一种循环方式, 用单元作循环, 为此我们需要考虑某个单元对整体刚度矩阵 $ A $ 的贡献. 为此, 我们需要把基函数 $ \phi_j $ 拆成不同单元上的部分, 比较自然的思路是记号的下标来记录这是第几个单元, 因此 $ \phi_j $ 应该被拆成一个 下标为 $ j $ 的函数和一个下标为 $ j+1 $ 的函数, 另外其实每个单元上一共只有两种行为, 要么斜向下一条线段, 要么斜向上一条线段, 我们用上标 $ 0 $ 来表示斜向上的, 上标 $ 1 $ 表示斜向下的, 这样我们定义了局部基函数
$$ \psi_j^0=\frac{x_j-x}{x_j-x_{j-1}}=\frac{1}{h_j}(x_j-x),\quad \psi_j^1=\frac{x-x_{j-1}}{x_j-x_{j-1}}=\frac{1}{h_j}(x-x_{j-1}) $$
要注意上面两个函数其实并不落在 $ V_h $ 中, 但因为我们不用他们来做理论的分析, 只是做运算, 所以没关系. 这样一来我们就有 
$$ \phi_j(x)=\psi_j^1(x)+\psi^0_{j+1}(x) $$
所以看到 $ \psi_j $ 出现在 $ \phi_j(x) $ 的 $ \psi_{j}^1(x) $ 部分和 $ \phi_{j-1}(x) $ 的 $ \psi_{j}^0(x) $部分, 所以第 $ j $ 个单元对刚度矩阵 $ A $ 的贡献出现在
$$ \begin{pmatrix}a(\phi_{j-1}(x),\phi_{j-1}(x))&a(\phi_{j-1}(x),\phi_{j}(x))\\a(\phi_{j}(x),\phi_{j-1}(x))&a(\phi_{j}(x),\phi_{j}(x))\end{pmatrix} $$

这些位置, 如果只把其中第 $ j $ 个单元带来的贡献写出来的话就是
$$ \begin{pmatrix}a(\psi_{j}^0(x),\psi_{j}^0(x))&a(\psi_{j}^0(x),\psi_{j}^1(x))\\a(\psi_{j}^1(x),\psi_{j}^0(x))&a(\psi_{j}^1(x),\psi_{j}^1(x))\end{pmatrix}=:\begin{pmatrix} k_j^{00}&k_j^{01}\\k_j^{10}&k_j^{11} \end{pmatrix}=\frac{1}{h_j}\begin{pmatrix}1&-1\\-1&1\end{pmatrix} $$

## 误差估计
设 $ u\in V=H_0^1(I) $ 是如下变分问题的解,

$$ a(u,v)=(f,v),\quad \forall v\in V $$

取 $ V_h\in V $, 设 $ u_h\in V_h $ 是如下有限元问题的解
$$ a(u_h,v_h)=(f,v_h),\quad \forall v_h\in V_h $$

$ u $ 当然满足如上等式, 但 $ u $ 不一定在子空间 $ V_h $ 中, 所以我们期待 $ u_h $ 作为 $ u $ 在子空间 $ V_h $ 中的投影, 当子空间 $ V_h $ 逼近 $ V $, $ u_h $ 也逼近 $ u $. 投影的说法在数学上可以严格化为如下误差方程
$$ a(u-u_h,v_h)=0,\quad \forall v_h\in V_h $$

当 $ a $ 定义了空间 $ V $ 上的内积时, $ u_h $ 就是 $ u $ 在 $ V_h $ 上的正交投影. 本节的标题误差估计说的就是对 $ u-u_h $ 的范数进行估计, 做了这个估计之后我们才知道用 $ u_h $ 来近似 $ u $ 的效果怎么样, 并且我们希望这个估计能与区间最大长度 $ h $ 建立起联系.

**推论** $ (u-u_h)'=\inf_{v\in V_h}(u-v)' $

**推论** $ (u-u_h)'\_{L^2}=\inf_{v\in V_h}(u-v)'\_{L^2} $

> **定理**  $ \|(u-u_h)'\|_{L^2}\leqslant \|(u-v)'\|_{L^2}, \forall v\in V_h. $

> **证明** $ ((u-u_h)',(u-u_h)')=((u-u_h)',(u-v)'+(v-u_h)')=((u-u_h)',(u-v)')\leqslant \|(u-u_h)'\|_{L^2}\|(u-v)'\|_{L^2} $.

**推论** $ \|(u-u_h)'\|_{L^2}=\inf_{v\in V_h}\|(u-v)'\|_{L^2} $

**推论** $ (u-u_h)'_{L^2}=\inf_{v\in V_h}(u-v)'_{L^2} $

上述推论的好处在于, 我们已经在前面的课程中研究过一个函数 $ u $ 及其分段线性插值 $ u_I $ 之间的误差估计, 而 $ u_I $ 又恰恰落在 $ V_h $ 中, 结合上述推论, 对 $ u-u_I $ 的估计可以直接给出 $ u-u_h $ 的估计.

> **定理** 分段线性插值的一阶导数的 $L^2$ 误差：$\|(u-u_I)'\|_{L^2}\leqslant Ch\|u''\|_{L^2}$, 其中 $ C $是一个与 $ u,h $无关的常数.

> **证明** 由Rolle中值定理，存在 $ \xi_j\in (x_j,x_{j+1}) $ 使得 $ (u-u_I)'(\xi_j)=0 $. 对任意 $ x\in (x_j,x_{j+1}) $,
> $$ (u-u_I)'(x)=\int_{\xi}^x(u-u_I)''(t)\mathrm{d}t=\int_{\xi}^xu''(t)\mathrm{d}t\leqslant |x-\xi|^{\frac{1}{2}}\|u''\|_{L^2[\xi,x]}\leqslant |x-\xi|^{\frac{1}{2}}\|u''\|_{L^2[x_j,x_{j+1}]}. $$
>
> $$ \int_{x_j}^{x_{j+1}}(u-u_I)'(x)^2\mathrm{d}x\leqslant \|u''\|_{L^2[x_j,x_{j+1}]}^2\int_{x_j}^{x_{j+1}}|x-\xi|\mathrm{d}x\leqslant h^2 \|u''\|_{L^2[x_j,x_{j+1}]}^2\Longrightarrow \|(u-u_I)'\|_{L^2}^2\leqslant h^2\|u''\|_{L^2}^2 $$ 

> **定理** 有限元方法近似解的 $ L^2 $ 误差：$ \|u-u_h\|_{L^2}\leqslant Ch^2\|u''\|_{L^2} $, 其中 $ C $是一个与 $ u,h $无关的常数.

> **证明** 考虑对偶方程
> $$ \begin{cases}-w''=u-u_h\\w(0)=w(1)=0\end{cases} $$
> 
> 我们有
> $$ \|u-u_h\|^2_{L^2}=(u-u_h,u-u_h)=(u-u_h,-w'')=((u-u_h)',w')$$
>
> 由误差方程, 对任意的 $ v_h\in V_h $有
> $$ \|u-u_h\|^2_{L^2}=((u-u_h)',(w-v_h)')\leqslant \|(u-u_h)'\|_{L^2}\|(w-v_h)'\|_{L^2} $$
>
> 取 $ v_h=w_I $, 则有
> $$ \|u-u_h\|^2_{L^2}\leqslant h\|(u-u_h)'\|_{L^2}\|w''\|_{L^2}=h\|(u-u_h)'\|_{L^2}\|u-u_h\|_{L^2} $$
> 
> 所以
> $$ \|u-u_h\|_{L^2}\leqslant h\|(u-u_h)'\|_{L^2}\leqslant h^2\|u''\|_{L^2} $$
